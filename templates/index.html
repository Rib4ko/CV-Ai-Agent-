<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Architect</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>

<header>
    <div class="logo-area">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="CV Agent Logo" class="main-logo">
    </div>
    <div class="auth-area" style="text-align:right; padding-right:10px;">
        {% if session.email %}
            <span>Signed in as <strong>{{ session.email }}</strong></span>
            <a href="{{ url_for('logout') }}" style="margin-left:10px;">Logout</a>
        {% else %}
            <a href="{{ url_for('login') }}">Login</a> | <a href="{{ url_for('register') }}">Register</a>
        {% endif %}
    </div>
    <p class="subtitle">build personlized Cv for each job you applay for!</p>
</header>

<div class="main-container">

    {% if error %}
    <div class="error-box" style="background: #fee2e2; color: #991b1b; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #f87171;">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}" style="padding:10px; border-radius:6px; margin-bottom:12px; background:#eef2ff;">
            {{ msg }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% if filename %}
    <div class="success-box">
        <h2>✅ Resume Generated!</h2>
        <p>Your tailored resume is ready.</p>
        <div class="action-buttons">
            <a href="{{ url_for('static', filename='resumes/' + filename) }}" target="_blank" class="btn-view">
                <i class="fa-regular fa-eye"></i> View PDF
            </a>
            <a href="{{ url_for('static', filename='resumes/' + filename) }}" download class="btn-download">
                <i class="fa-solid fa-download"></i> Download
            </a>
        </div>
    </div>

    <!-- Review prompt shown after generation -->
    <div id="review-box" class="review-box" role="dialog" aria-live="polite">
        <button class="review-close" aria-label="Close review" onclick="closeReview()">×</button>
        <h4>What would you like to see in next versions of this app?</h4>
        <textarea id="review-text" placeholder="Share one or two ideas..." maxlength="500"></textarea>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <button id="review-submit" class="btn-view">Send feedback</button>
            <span id="review-status" style="display:none;color:#2c3e50;font-weight:600;">Thanks!</span>
        </div>
    </div>
    {% endif %} 

    <form id="resume-form" method="POST" action="/" enctype="multipart/form-data" data-saved-resume="{{ '1' if saved_resume else '' }}">

        <div class="split-container">

            <div class="column left-col">
                <div class="col-header">
                    <h3>1. Candidate Profile</h3>
                    <span class="helper-text">Upload your details to get started.</span>
                </div>

                <div class="input-group">
                   <label for="profile-pic"><i class="fa-solid fa-camera"></i> Profile Photo (Optional)</label>
    <input type="file" name="profile-pic" accept="image/*" class="file-input">

    <small style="color: #7f8c8d; font-size: 0.75rem; display: block; margin-top: 4px;">
        <i class="fa-solid fa-circle-info"></i>
        AI will auto-crop to square. Best results: JPG/PNG, min 300x300px.
    </small>
                </div>

                <div class="divider"><span>AND / OR</span></div>

                <div class="input-group">
                    <label for="user-pdf"><i class="fa-solid fa-file-pdf"></i> Upload Current Resume (PDF)</label>
                    <input type="file" name="user-pdf" accept=".pdf" class="file-input">
                    {% if saved_resume %}
                    <div class="saved-resume" style="margin-top:8px; font-size:0.9rem;">
                        <strong>Saved resume:</strong>
                        {% if saved_resume_name %}
                            <span>{{ saved_resume_name }}</span>
                        {% else %}
                            <span>(Saved resume text present)</span>
                        {% endif %}
                        <button type="button" class="btn-delete" style="background:#f87171;color:white;border:none;padding:4px 8px;border-radius:4px; margin-left:10px;" onclick="deleteSavedResume()">Delete</button>
                        <p class="helper-text" style="margin-top:4px;">Your saved resume text will be used automatically on submit unless you upload a new one.</p>
                    </div>
                    {% endif %}
                </div>

                <div class="divider"><span>OR PASTE TEXT</span></div>

                <div class="input-group">
                    <label for="user-data"><i class="fa-solid fa-keyboard"></i> Manual Data Entry</label>
                    <textarea name="user-data" placeholder="Paste your bio, work history, and skills here if you don't have a PDF..."></textarea>
                </div>
            </div>

            <div class="column right-col">
                <div class="col-header">
                    <h3>2. Target Job</h3>
                    <span class="helper-text">Paste the job description you want to win.</span>
                </div>

                <div class="input-group full-height">
                    <label for="job-post"><i class="fa-solid fa-briefcase"></i> Job Description</label>
                    <textarea name="job-post" required placeholder="Paste the full job description here (Responsibilities, Requirements, etc.)..." style="height: 100%; min-height: 400px;"></textarea>
                </div>
            </div>
        </div>

        <div class="bottom-bar">
    <div class="left-section">
        <div class="info-text">
            <i class="fa-solid fa-shield-halved"></i> Developed by <strong>Amine Taghi</strong>
        </div>

        <span class="separator">|</span>

        <div class="social-icons">
            <a href="https://www.linkedin.com/in/amine-taghi-898a44253/" target="_blank" title="LinkedIn">
                <i class="fa-brands fa-linkedin"></i>
            </a>
            <a href="mailto:taghi.amine05@gmail.com" title="Email Me">
                <i class="fa-solid fa-envelope"></i>
            </a>
        </div>
    </div>

    <button type="submit" class="generate-btn">
        ✨ Generate Resume
    </button>
</div>

    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('resume-form');
  if (!form) return;
  const submitBtn = form.querySelector('.generate-btn');
  const job = form.querySelector('[name="job-post"]');
  const userPdf = form.querySelector('[name="user-pdf"]');
  const userData = form.querySelector('[name="user-data"]');

  form.addEventListener('submit', function(e){
    // Clear previous client-side error
    const old = document.getElementById('client-error');
    if (old) old.remove();

    if (!job || !job.value.trim()){
      e.preventDefault();
      showClientError('Please paste the target job description in the right-hand box.');
      if (job) job.focus();
      return;
    }

    const hasSaved = !!form.dataset.savedResume;
    const hasPdf = userPdf && userPdf.files && userPdf.files.length > 0;
    const hasText = userData && userData.value && userData.value.trim().length > 0;

    if (!hasPdf && !hasText && !hasSaved){
      e.preventDefault();
      showClientError('Upload a PDF, paste your resume text, or use your saved resume first.');
      return;
    }

    // Provide immediate UI feedback
    if (submitBtn){
      submitBtn.disabled = true;
      submitBtn.textContent = '⏳ Generating...';
    }
  });

  function showClientError(msg){
    const container = document.createElement('div');
    container.id = 'client-error';
    container.className = 'error-box';
    container.style = 'background:#fee2e2;color:#991b1b;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;border:1px solid #f87171;';
    container.innerHTML = '<strong>Error:</strong> ' + msg;
    const main = document.querySelector('.main-container');
    main.insertBefore(container, main.firstChild);
  }

  // Delete saved resume (replaces nested form to avoid invalid HTML)
  window.deleteSavedResume = async function(){
    if (!confirm('Delete your saved resume?')) return;
    try {
      const res = await fetch("{{ url_for('delete_resume') }}", { method: 'POST', credentials: 'same-origin' });
      if (res.ok) {
        // reload to update UI
        window.location.reload();
      } else {
        showClientError('Failed to delete saved resume.');
      }
    } catch (err) {
      showClientError('Failed to delete saved resume.');
    }
  };

  // Review box handlers
  window.closeReview = function(){
    const box = document.getElementById('review-box');
    if (box) box.remove();
  }

  document.addEventListener('click', function(e){
    if (e.target && e.target.id === 'review-submit'){
      const txt = document.getElementById('review-text');
      if (!txt || !txt.value.trim()){
        showClientError('Please enter some feedback before sending.');
        return;
      }
      const status = document.getElementById('review-status');
      const submitBtn = document.getElementById('review-submit');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      fetch("{{ url_for('submit_review') }}", {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ feedback: txt.value.trim(), filename: '{{ filename }}' })
      }).then(r => r.json()).then(j => {
        if (j && j.ok){
          if (status) status.style.display = 'inline';
          if (txt) txt.value = '';
          setTimeout(closeReview, 1000);
        } else {
          showClientError(j && j.error ? j.error : 'Failed to send feedback');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Send feedback';
        }
      }).catch(err => {
        showClientError('Failed to send feedback');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send feedback';
      });
    }
  });

});
</script>

</body>
</html>